# üìß UPDATE EMAIL IMPLEMENTATION GUIDE

## üìã T·ªîNG QUAN

T√≠nh nƒÉng **Update Email** cho ph√©p ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p:
- **Th√™m email** n·∫øu ch∆∞a c√≥ email trong t√†i kho·∫£n
- **Thay ƒë·ªïi email** n·∫øu ƒë√£ c√≥ email hi·ªán t·∫°i

### ‚ú® ƒê·∫∂C ƒêI·ªÇM CH√çNH

1. **X√°c th·ª±c ƒëa l·ªõp**: M·∫≠t kh·∫©u hi·ªán t·∫°i ‚Üí OTP qua phone ‚Üí Email m·ªõi
2. **Ph√¢n bi·ªát tr·∫°ng th√°i**: T·ª± ƒë·ªông nh·∫≠n di·ªán user c√≥/ch∆∞a c√≥ email
3. **B·∫£o m·∫≠t cao**: Rate limiting, OTP expiration, email validation
4. **UX t·ªët**: Session persistence, countdown timer, attempts tracking
5. **CSS ƒë·ªìng b·ªô**: Thi·∫øt k·∫ø nh·∫•t qu√°n v·ªõi ChangePassword

---

## üîÑ LU·ªíNG HO·∫†T ƒê·ªòNG

### **FLOW CHUNG (√Åp d·ª•ng cho c·∫£ Add v√† Change Email)**

```
Step 1: X√°c th·ª±c m·∫≠t kh·∫©u hi·ªán t·∫°i
   ‚Üì
   Backend ki·ªÉm tra:
   - User c√≥ t·ªìn t·∫°i?
   - M·∫≠t kh·∫©u ƒë√∫ng?
   - C√≥ phone number?
   - Rate limiting (max 3 requests/15 ph√∫t)
   ‚Üì
   Generate OTP + resetToken ‚Üí G·ª≠i v·ªÅ phone
   ‚Üì
   Response: { hasEmail: true/false, currentEmail: string/null }
   ‚Üì
Step 2: X√°c th·ª±c OTP
   ‚Üì
   Backend ki·ªÉm tra:
   - OTP ƒë√∫ng?
   - Ch∆∞a h·∫øt h·∫°n? (15 ph√∫t)
   - S·ªë l·∫ßn th·ª≠? (max 3 attempts)
   ‚Üì
   OTP verified ‚Üí Chuy·ªÉn sang step 3
   ‚Üì
Step 3: Nh·∫≠p email m·ªõi
   ‚Üì
   Validate email format + Check duplicate
   ‚Üì
   Backend update email ‚Üí Success
   ‚Üì
   Refresh user profile trong Redux
```

---

## üîê BACKEND IMPLEMENTATION

### 1Ô∏è‚É£ **Service Layer** (`authService.js`)

#### **`requestUpdateEmail`**

```javascript
let requestUpdateEmail = async (userId, currentPassword, ipAddress, userAgent)
```

**Ch·ª©c nƒÉng:**
- X√°c th·ª±c m·∫≠t kh·∫©u hi·ªán t·∫°i
- L·∫•y `phoneNumber` t·ª´ database
- Rate limiting (3 requests/15 ph√∫t)
- Generate `resetToken` + `otpCode`
- G·ª≠i OTP qua SMS (console log trong dev)
- Tr·∫£ v·ªÅ `hasEmail` v√† `currentEmail`

**Response:**
```javascript
{
   errCode: 0,
   message: "M√£ OTP ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn s·ªë ƒëi·ªán tho·∫°i c·ªßa b·∫°n.",
   resetToken: "abc123...",
   expiresIn: 15,
   hasEmail: true/false,
   currentEmail: "user@example.com" | null
}
```

**Error Codes:**
- `1`: Ng∆∞·ªùi d√πng kh√¥ng t·ªìn t·∫°i
- `2`: M·∫≠t kh·∫©u hi·ªán t·∫°i kh√¥ng ch√≠nh x√°c
- `3`: T√†i kho·∫£n ch∆∞a c√≥ s·ªë ƒëi·ªán tho·∫°i
- `4`: Qu√° nhi·ªÅu y√™u c·∫ßu (rate limiting)
- `5`: Kh√¥ng th·ªÉ g·ª≠i OTP

---

#### **`updateEmail`**

```javascript
let updateEmail = async (resetToken, newEmail)
```

**Ch·ª©c nƒÉng:**
- Validate email format (s·ª≠ d·ª•ng `validator.isEmail`)
- Verify `resetToken` (check expiration + used status)
- Check email duplicate (kh√¥ng tr√πng v·ªõi user kh√°c)
- Update email v√†o database
- Mark token as used

**Response:**
```javascript
{
   errCode: 0,
   message: "C·∫≠p nh·∫≠t email th√†nh c√¥ng!"
}
```

**Error Codes:**
- `1`: Email kh√¥ng h·ª£p l·ªá
- `2`: Token kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n
- `3`: Email n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng b·ªüi t√†i kho·∫£n kh√°c

---

### 2Ô∏è‚É£ **Controller Layer** (`authController.js`)

#### **`handleRequestUpdateEmail`**

```javascript
const handleRequestUpdateEmail = async (req, res)
```

**Input:**
- `req.body.currentPassword`: M·∫≠t kh·∫©u hi·ªán t·∫°i
- `req.user.id`: User ID t·ª´ JWT token (middleware `verifyToken`)

**Output:**
```javascript
{
   errCode: 0,
   message: "M√£ OTP ƒë√£ ƒë∆∞·ª£c g·ª≠i...",
   resetToken: "...",
   expiresIn: 15,
   hasEmail: true,
   currentEmail: "user@example.com"
}
```

---

#### **`handleUpdateEmail`**

```javascript
const handleUpdateEmail = async (req, res)
```

**Input:**
- `req.body.resetToken`: Token t·ª´ step 2
- `req.body.newEmail`: Email m·ªõi

**Output:**
```javascript
{
   errCode: 0,
   message: "C·∫≠p nh·∫≠t email th√†nh c√¥ng!"
}
```

---

### 3Ô∏è‚É£ **Routes** (`apiUser.js`)

```javascript
// üìß Update Email (for authenticated users)
router.post('/request-update-email',
   verifyToken,
   validateBodyFields(['currentPassword']),
   authController.handleRequestUpdateEmail
);

router.post('/verify-email-otp',
   verifyToken,
   validateBodyFields(['phoneNumber', 'otpCode']),
   authController.handleVerifyResetOTP // Reuse t·ª´ forgot password
);

router.post('/update-email',
   verifyToken,
   validateBodyFields(['resetToken', 'newEmail']),
   authController.handleUpdateEmail
);
```

**Middleware:**
- `verifyToken`: B·∫£o v·ªá route, ch·ªâ cho ph√©p user ƒë√£ login
- `validateBodyFields`: Validate required fields

---

## üíª FRONTEND IMPLEMENTATION

### 1Ô∏è‚É£ **Services** (`authService.js`)

```javascript
export const requestUpdateEmail = async (currentPassword) => {
   const res = await axios.post('/api/user/request-update-email', { currentPassword });
   return res;
};

export const verifyEmailOTP = async (phoneNumber, otpCode) => {
   const res = await axios.post('/api/user/verify-email-otp', { phoneNumber, otpCode });
   return res;
};

export const updateEmail = async (resetToken, newEmail) => {
   const res = await axios.post('/api/user/update-email', { resetToken, newEmail });
   return res;
};
```

---

### 2Ô∏è‚É£ **Component** (`UpdateEmail.js`)

#### **State Management**

```javascript
const [step, setStep] = useState(1);              // 1: Password, 2: OTP, 3: Email
const [currentPassword, setCurrentPassword] = useState('');
const [otpCode, setOTPCode] = useState('');
const [newEmail, setNewEmail] = useState('');
const [resetToken, setResetToken] = useState('');
const [countdown, setCountdown] = useState(0);    // OTP countdown (300s)
const [attemptsRemaining, setAttemptsRemaining] = useState(3);
const [hasEmail, setHasEmail] = useState(false);  // User c√≥ email ch∆∞a?
const [currentEmail, setCurrentEmail] = useState(''); // Email hi·ªán t·∫°i
```

---

#### **Step 1: X√°c th·ª±c m·∫≠t kh·∫©u**

```javascript
const handleVerifyPassword = async (e) => {
   e.preventDefault();
   
   const response = await requestUpdateEmail(currentPassword);
   
   if (response.errCode === 0) {
      setResetToken(response.resetToken);
      setHasEmail(response.hasEmail);        // ‚úÖ Quan tr·ªçng
      setCurrentEmail(response.currentEmail);
      setStep(2);
      setCountdown(300); // 5 ph√∫t
   }
};
```

**Hi·ªÉn th·ªã:**
- N·∫øu `hasEmail && currentEmail`: Hi·ªÉn th·ªã email hi·ªán t·∫°i
- Title: "Th√™m Email" ho·∫∑c "Thay ƒë·ªïi Email" (d·ª±a v√†o `hasEmail`)

---

#### **Step 2: X√°c th·ª±c OTP**

```javascript
const handleVerifyOTP = async (e) => {
   e.preventDefault();
   
   const response = await verifyEmailOTP(phoneNumber, otpCode);
   
   if (response.errCode === 0) {
      setResetToken(response.resetToken);
      setStep(3);
   } else {
      setAttemptsRemaining(Math.max(0, attemptsRemaining - 1));
      
      if (attemptsRemaining === 0) {
         // Quay v·ªÅ step 1
         setStep(1);
      }
   }
};
```

**Features:**
- ‚è±Ô∏è Countdown timer (5 ph√∫t)
- üîÑ Resend OTP
- ‚¨ÖÔ∏è Quay l·∫°i step 1
- ‚ö†Ô∏è Hi·ªÉn th·ªã s·ªë l·∫ßn th·ª≠ c√≤n l·∫°i
- üö´ Auto clear OTP khi h·∫øt h·∫°n

---

#### **Step 3: Nh·∫≠p email m·ªõi**

```javascript
const handleUpdateEmail = async (e) => {
   e.preventDefault();
   
   // Validate email format
   const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
   if (!emailRegex.test(newEmail)) {
      // Show error toast
      return;
   }
   
   const response = await updateEmail(resetToken, newEmail);
   
   if (response.errCode === 0) {
      // Success toast
      
      // Refresh user profile
      const profileResult = await getUserProfile();
      if (profileResult.errCode === 0) {
         dispatch(adminLoginSuccess(profileResult.user));
      }
      
      // Reset form
      setStep(1);
      setCurrentPassword('');
      setNewEmail('');
   }
};
```

**Validation:**
- Email kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng
- Email ph·∫£i ƒë√∫ng format
- Backend ki·ªÉm tra duplicate

---

### 3Ô∏è‚É£ **Styling** (`UpdateEmail.scss`)

```scss
.update-email {
    max-width: 500px;
    margin: 0 auto;
    padding: 40px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    
    // ‚úÖ ƒê·ªìng b·ªô v·ªõi ChangePassword.scss
    // ‚úÖ Responsive design
    // ‚úÖ Animations
}
```

**C√°c class ch√≠nh:**
- `update-email__title`: Title m·ªói step
- `update-email__current`: Hi·ªÉn th·ªã email hi·ªán t·∫°i (n·∫øu c√≥)
- `update-email__form`: Container form
- `update-email__field`: M·ªói input field
- `update-email__btn--primary`: Button ch√≠nh
- `update-email__btn--outline`: Button ph·ª•
- `update-email__timer`: Countdown display

---

### 4Ô∏è‚É£ **Translations** (`vi.json`)

```json
"update_email": {
    "add_title": "Th√™m Email",
    "change_title": "Thay ƒë·ªïi Email",
    "otp_title": "X√°c th·ª±c OTP",
    "new_email_title": "Nh·∫≠p Email m·ªõi",
    "current_email": "Email hi·ªán t·∫°i",
    "password_label": "M·∫≠t kh·∫©u hi·ªán t·∫°i *",
    "email_label": "Email *",
    "new_email_label": "Email m·ªõi *",
    "add_button": "Th√™m Email",
    "change_button": "Thay ƒë·ªïi Email",
    // ... v√† nhi·ªÅu keys kh√°c
}
```

**S·ª≠ d·ª•ng:**
```jsx
<FormattedMessage id={hasEmail ? "update_email.change_title" : "update_email.add_title"} />
```

---

### 5Ô∏è‚É£ **Integration** (`AccountPage.js`)

```javascript
import UpdateEmail from './UpdateEmail';

const menuItems = [
   // ...
   {
      id: 'email',
      icon: <FaEnvelope />,
      labelId: 'account.menu.email',
      defaultLabel: 'C·∫≠p nh·∫≠t email',
      component: <UpdateEmail />  // ‚úÖ ƒê√£ t√≠ch h·ª£p
   },
   // ...
];
```

---

## üõ°Ô∏è B·∫¢O M·∫¨T

### **Backend Security**

1. ‚úÖ **X√°c th·ª±c m·∫≠t kh·∫©u hi·ªán t·∫°i** tr∆∞·ªõc khi g·ª≠i OTP
2. ‚úÖ **Rate Limiting**: Max 3 OTP requests trong 15 ph√∫t
3. ‚úÖ **OTP Expiration**: OTP c√≥ hi·ªáu l·ª±c 15 ph√∫t
4. ‚úÖ **OTP Attempts**: Max 3 l·∫ßn verify OTP
5. ‚úÖ **Token-based**: S·ª≠ d·ª•ng `resetToken` ƒë·ªÉ li√™n k·∫øt c√°c step
6. ‚úÖ **Email Validation**: Validate format + check duplicate
7. ‚úÖ **One-time use**: Token ƒë∆∞·ª£c mark as used sau khi update th√†nh c√¥ng

### **Frontend Security**

1. ‚úÖ **Protected Routes**: Ch·ªâ user ƒë√£ login m·ªõi truy c·∫≠p
2. ‚úÖ **JWT Token**: G·ª≠i k√®m trong m·ªçi request (axios interceptor)
3. ‚úÖ **Input Validation**: Validate tr∆∞·ªõc khi g·ª≠i request
4. ‚úÖ **No session storage**: Kh√¥ng l∆∞u sensitive data (kh√°c v·ªõi ChangePassword)
5. ‚úÖ **Auto-clear OTP**: X√≥a OTP khi h·∫øt countdown

---

## üìä SO S√ÅNH V·ªöI CHANGE PASSWORD

| ƒê·∫∑c ƒëi·ªÉm | Change Password | Update Email |
|----------|-----------------|--------------|
| **OTP Destination** | Phone | Phone |
| **Session Storage** | ‚úÖ Yes (persistence) | ‚ùå No |
| **Logout sau khi th√†nh c√¥ng** | ‚úÖ Yes (force logout) | ‚ùå No |
| **Check duplicate** | N/A | ‚úÖ Yes (email) |
| **Validation** | Password strength | Email format |
| **Refresh Profile** | N/A | ‚úÖ Yes (update Redux) |

---

## üß™ TESTING CHECKLIST

### **Scenario 1: Th√™m email (User ch∆∞a c√≥ email)**

- [ ] User nh·∫≠p m·∫≠t kh·∫©u ƒë√∫ng ‚Üí OTP ƒë∆∞·ª£c g·ª≠i
- [ ] Title hi·ªÉn th·ªã "Th√™m Email"
- [ ] Kh√¥ng hi·ªÉn th·ªã "Email hi·ªán t·∫°i"
- [ ] OTP verify th√†nh c√¥ng ‚Üí Chuy·ªÉn step 3
- [ ] Nh·∫≠p email m·ªõi ‚Üí Update th√†nh c√¥ng
- [ ] Button hi·ªÉn th·ªã "Th√™m Email"

### **Scenario 2: ƒê·ªïi email (User ƒë√£ c√≥ email)**

- [ ] User nh·∫≠p m·∫≠t kh·∫©u ƒë√∫ng ‚Üí OTP ƒë∆∞·ª£c g·ª≠i
- [ ] Title hi·ªÉn th·ªã "Thay ƒë·ªïi Email"
- [ ] Hi·ªÉn th·ªã email hi·ªán t·∫°i
- [ ] OTP verify th√†nh c√¥ng ‚Üí Chuy·ªÉn step 3
- [ ] Nh·∫≠p email m·ªõi ‚Üí Update th√†nh c√¥ng
- [ ] Button hi·ªÉn th·ªã "Thay ƒë·ªïi Email"

### **Scenario 3: Error Handling**

- [ ] M·∫≠t kh·∫©u sai ‚Üí Error toast
- [ ] OTP sai (3 l·∫ßn) ‚Üí Quay v·ªÅ step 1
- [ ] OTP h·∫øt h·∫°n ‚Üí Toast warning
- [ ] Email tr√πng ‚Üí Error toast "Email ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng"
- [ ] Email sai format ‚Üí Error toast "Email kh√¥ng h·ª£p l·ªá"
- [ ] Rate limiting ‚Üí Error toast "Qu√° nhi·ªÅu y√™u c·∫ßu"

### **Scenario 4: UX Testing**

- [ ] Countdown timer ho·∫°t ƒë·ªông ƒë√∫ng
- [ ] Resend OTP reset countdown
- [ ] Quay l·∫°i step 1 clear h·∫øt data
- [ ] Profile ƒë∆∞·ª£c refresh sau update
- [ ] Responsive tr√™n mobile/tablet
- [ ] Loading states ho·∫°t ƒë·ªông

---

## üöÄ API ENDPOINTS

```bash
# 1. Request OTP (Protected)
POST /api/user/request-update-email
Authorization: Bearer <JWT_TOKEN>
Body: { "currentPassword": "123456" }

# 2. Verify OTP (Protected)
POST /api/user/verify-email-otp
Authorization: Bearer <JWT_TOKEN>
Body: { "phoneNumber": "0123456789", "otpCode": "123456" }

# 3. Update Email (Protected)
POST /api/user/update-email
Authorization: Bearer <JWT_TOKEN>
Body: { "resetToken": "abc123...", "newEmail": "newemail@example.com" }
```

---

## üìù NOTES

1. **OTP lu√¥n g·ª≠i v·ªÅ phone**, kh√¥ng g·ª≠i v·ªÅ email (v√¨ user c√≥ th·ªÉ m·∫•t access email c≈©)
   - ‚ö†Ô∏è **TODO FUTURE**: Sau n√†y s·∫Ω thay ƒë·ªïi ƒë·ªÉ g·ª≠i OTP v·ªÅ email thay v√¨ phone number
2. **Kh√¥ng c·∫ßn logout** sau khi update email th√†nh c√¥ng
3. **Profile ƒë∆∞·ª£c refresh** t·ª± ƒë·ªông sau update th√†nh c√¥ng
4. **Reuse `handleVerifyResetOTP`** controller t·ª´ forgot password flow
5. **CSS ho√†n to√†n ƒë·ªìng b·ªô** v·ªõi ChangePassword
6. **Translation keys** r√µ r√†ng, d·ªÖ maintain
7. **Import fix**: `getUserProfile` n·∫±m trong `userService.js` ch·ª© kh√¥ng ph·∫£i `authService.js`

---

## ‚úÖ HO√ÄN TH√ÄNH

- [x] Backend services (`requestUpdateEmail`, `updateEmail`)
- [x] Backend controllers (`handleRequestUpdateEmail`, `handleUpdateEmail`)
- [x] Backend routes (`/request-update-email`, `/verify-email-otp`, `/update-email`)
- [x] Frontend services (axios calls)
- [x] Frontend component (`UpdateEmail.js`)
- [x] Frontend styling (`UpdateEmail.scss`)
- [x] Translations (`vi.json`)
- [x] Integration v√†o `AccountPage.js`
- [x] Linter check (No errors)

---

## üéâ K·∫æT LU·∫¨N

T√≠nh nƒÉng **Update Email** ƒë√£ ƒë∆∞·ª£c implement ho√†n ch·ªânh v·ªõi:
- ‚úÖ Security t·ªët (password + OTP + validation)
- ‚úÖ UX t·ªët (countdown, attempts, auto-refresh)
- ‚úÖ Code clean, maintainable
- ‚úÖ ƒê·ªìng b·ªô v·ªõi design system hi·ªán t·∫°i
- ‚úÖ Kh√¥ng c√≥ linter errors

User gi·ªù c√≥ th·ªÉ:
1. Th√™m email n·∫øu ch∆∞a c√≥
2. ƒê·ªïi email n·∫øu ƒë√£ c√≥
3. T·∫•t c·∫£ ƒë·ªÅu an to√†n v√† d·ªÖ s·ª≠ d·ª•ng!

---

**Ng√†y ho√†n th√†nh:** 2025-10-25
**Developer:** AI Assistant
**Version:** 1.0.0

